{% extends "base.html" %}
{% block title %}Tạo Hồ sơ - EHR ABE Demo{% endblock %}

{% block head %}
<!-- CSS không thay đổi, giữ nguyên -->
<style>
.policy-builder { background: #f8f9fa; padding: 25px; border-radius: 12px; margin: 20px 0; border: 1px solid #dee2e6; }
.attribute-group { margin-bottom: 20px; padding: 15px; background: #ffffff; border-radius: 8px; border: 1px solid #e9ecef; }
.attribute-group h4 { color: #2c3e50; margin-bottom: 10px; font-size: 1.1em; }
.attribute-selector { display: flex; flex-wrap: wrap; gap: 10px; }
.attribute-option { display: inline-block; padding: 8px 15px; border: 2px solid #ccc; border-radius: 20px; cursor: pointer; user-select: none; transition: all 0.2s ease-in-out; font-size: 0.9em; }
.attribute-option:hover { border-color: #3498db; background: #eaf5fc; }
.attribute-option.selected { background-color: #3498db; color: white; border-color: #2980b9; font-weight: 600; }
textarea#policy-expression { background-color: #f0f0f0; cursor: not-allowed; font-family: monospace; font-size: 1em; color: #333; }
.status-panel { background: #f8f9fa; border-left: 5px solid #27ae60; padding: 20px; margin: 20px 0; border-radius: 0 8px 8px 0; }
.status-panel ul { list-style-type: none; padding-left: 5px; }
.status-panel li { margin-top: 10px; }
</style>
{% endblock %}


{% block content %}
<h2>📝 Tạo và Mã hóa Hồ sơ Bệnh án</h2>

<!-- ======================================================================= -->
<!-- LOGIC HIỂN THỊ DỰA TRÊN BIẾN `step` TỪ FLASK -->
<!-- ======================================================================= -->

{% if step == 'prepare' or not step %}
    <!-- ==================== BƯỚC 1: FORM CHUẨN BỊ VÀ MÃ HÓA ==================== -->
    <form id="data-creator-form" action="{{ url_for('creator.encrypt') }}" method="POST" enctype="multipart/form-data">
        <h3>Bước 1: Chuẩn bị và Mã hóa</h3>
        <p>Điền thông tin, chọn file, xây dựng chính sách và nhấn "Mã hóa". Dữ liệu sẽ được mã hóa an toàn trên server.</p>

        <div class="form-group">
          <label for="patient_name">Tên Bệnh nhân</label>
          <input type="text" id="patient_name" name="patient_name" placeholder="Ví dụ: Nguyễn Văn A" required class="form-control" />
        </div>
        
        <div class="form-group">
          <label for="medical_file">Hồ sơ y tế (chọn file)</label>
          <input type="file" id="medical_file" name="medical_file" accept=".txt,.pdf,.jpg,.png" required class="form-control" />
          <p id="file-name-display" style="margin-top: 5px; font-style: italic; color: #555;"></p>
        </div>
        
        <div class="form-group">
          <label for="public_key_file">Public Key của Hệ thống (chọn file .pk)</label>
          <input type="file" id="public_key_file" name="public_key_file" accept=".pk" required class="form-control" />
        </div>
        
        <!-- Policy Builder -->
        <div class="policy-builder">
            <h3>🔒 Xây dựng Chính sách Truy cập (CP-ABE)</h3>
            <p>Chọn các thuộc tính. Các thuộc tính trong cùng một nhóm sẽ được kết nối bằng toán tử `or`, giữa các nhóm khác nhau sẽ là `and`.</p>
            
            <div class="attribute-group">
                <h4>👥 Vai trò (chọn ít nhất 1):</h4>
                <div class="attribute-selector">
                    <div class="attribute-option" data-group="role" data-policy="role:Doctor">👨‍⚕️ Bác sĩ</div>
                    <div class="attribute-option" data-group="role" data-policy="role:Nurse">👩‍⚕️ Y tá</div>
                    <div class="attribute-option" data-group="role" data-policy="role:Researcher">🔬 Nhà nghiên cứu</div>
                </div>
            </div>
            <div class="attribute-group">
                <h4>🏥 Chuyên khoa (tùy chọn):</h4>
                <div class="attribute-selector">
                    <div class="attribute-option" data-group="dept" data-policy="dept:Cardiology">❤️ Khoa Tim mạch</div>
                    <div class="attribute-option" data-group="dept" data-policy="dept:Neurology">🧠 Khoa Thần kinh</div>
                    <div class="attribute-option" data-group="dept" data-policy="dept:Emergency">🚨 Khoa Cấp cứu</div>
                </div>
            </div>

            <div class="form-group">
                <label for="policy-expression">Chính sách được tạo (Read-only)</label>
                <textarea id="policy-expression" name="policy_expression" rows="3" placeholder="Chính sách sẽ hiện ở đây sau khi bạn nhấn nút 'Tạo Chính sách'" readonly required></textarea>
            </div>
            
            <button type="button" class="btn btn-primary" id="generate-policy-btn">⚙️ Tạo Chính sách</button>
            <button type="button" class="btn btn-danger" id="clear-all-btn">🗑️ Xóa lựa chọn</button>
        </div>

        <button type="submit" class="btn btn-success" style="margin-top: 20px; width: 100%; padding: 15px; font-size: 1.2em;">🔒 Bắt đầu Mã hóa</button>
    </form>
{% endif %}


<!-- ======================================================================= -->
<!-- == PHẦN BỊ THIẾU ĐÃ ĐƯỢC BỔ SUNG LẠI TẠI ĐÂY == -->
<!-- ======================================================================= -->
{% if step == 'confirm' %}
    <!-- ==================== BƯỚC 2: FORM XÁC NHẬN VÀ UPLOAD ==================== -->
    <h3>Bước 2: Xác nhận và Tải lên Cloud</h3>
    
    <div class="status-panel">
        <h4 style="color: #155724;">✅ Mã hóa thành công!</h4>
        <p>Các tệp sau đã được tạo trên server và sẵn sàng để tải lên Cloud cho bệnh nhân <strong>{{ files.patient_name }}</strong>:</p>
        <ul>
            <li><strong>Bản mã hồ sơ:</strong> <code>{{ files.ciphertext_file }}</code></li>
            <li><strong>Khóa mã hóa:</strong> <code>{{ files.key_file }}</code></li>
            <li><strong>Chính sách áp dụng:</strong> <code>{{ files.policy }}</code></li>
        </ul>
    </div>
    
    <form action="{{ url_for('creator.upload') }}" method="POST">
        <p>Nhấn nút dưới đây để hoàn tất việc tải hồ sơ đã mã hóa lên cơ sở dữ liệu trên Cloud.</p>
        <button type="submit" class="btn btn-success" style="width: 100%; padding: 15px; font-size: 1.2em;">☁️ Tải lên Cloud</button>
        <a href="{{ url_for('creator.data_creator') }}" class="btn btn-danger" style="width: 100%; padding: 15px; font-size: 1.2em; text-align: center;">Hủy bỏ và Bắt đầu lại</a>
    </form>
{% endif %}

{% endblock %}


{% block scripts %}
<script>
// Chờ cho toàn bộ tài liệu HTML được tải xong rồi mới chạy mã JS
document.addEventListener('DOMContentLoaded', function() {
  
  // --- Tự động gắn sự kiện cho các nút chọn thuộc tính ---
  const attributeOptions = document.querySelectorAll('.attribute-option');
  attributeOptions.forEach(option => {
    option.addEventListener('click', function() {
      this.classList.toggle('selected');
    });
  });

  // --- Tự động gắn sự kiện cho nút "Tạo Chính sách" ---
  const generateBtn = document.getElementById('generate-policy-btn');
  if(generateBtn) {
      generateBtn.addEventListener('click', function() {
          const groups = {};
          const selectedElems = document.querySelectorAll('.attribute-option.selected');
          
          if (selectedElems.length === 0) {
              alert('Vui lòng chọn ít nhất một thuộc tính!');
              return;
          }
          
          selectedElems.forEach(el => {
              const group = el.getAttribute('data-group');
              const policy = el.getAttribute('data-policy');
              if (!groups[group]) {
                  groups[group] = [];
              }
              groups[group].push(policy);
          });
          
          if (!groups.role || groups.role.length === 0) {
              alert('Bắt buộc phải chọn ít nhất một thuộc tính trong nhóm "Vai trò"!');
              return;
          }
          
          const policyParts = [];
          for (const policies of Object.values(groups)) {
              if (policies.length > 1) {
                  policyParts.push(`(${policies.join(' or ')})`);
              } else {
                  policyParts.push(policies[0]);
              }
          }
          
          const finalPolicy = policyParts.join(' and ');
          document.getElementById('policy-expression').value = finalPolicy;
          alert('✅ Chính sách đã được tạo thành công!');
      });
  }
  
  // --- Tự động gắn sự kiện cho nút "Xóa lựa chọn" ---
  const clearBtn = document.getElementById('clear-all-btn');
  if(clearBtn) {
      clearBtn.addEventListener('click', function() {
          document.querySelectorAll('.attribute-option.selected').forEach(el => el.classList.remove('selected'));
          document.getElementById('policy-expression').value = '';
      });
  }

  // --- Gắn sự kiện kiểm tra form trước khi gửi ---
  const mainForm = document.getElementById('data-creator-form');
  if (mainForm) {
      mainForm.addEventListener('submit', function(event) {
          const policyText = document.getElementById('policy-expression').value.trim();
          if (policyText.length === 0) {
              alert('Vui lòng "Tạo Chính sách" trước khi mã hóa!');
              event.preventDefault(); // Ngăn form được gửi đi
          }
      });
  }

  // --- Hiển thị tên file đã chọn ---
  const fileInput = document.getElementById('medical_file');
  const fileNameDisplay = document.getElementById('file-name-display');
  if (fileInput) {
      fileInput.addEventListener('change', function() {
          if (this.files.length > 0) {
              fileNameDisplay.textContent = `Đã chọn: ${this.files[0].name}`;
          } else {
              fileNameDisplay.textContent = '';
          }
      });
  }

});
</script>
{% endblock %}