{% extends "base.html" %}
{% block title %}Táº¡o Há»“ sÆ¡ - EHR ABE Demo{% endblock %}

{% block head %}
<!-- CSS khÃ´ng thay Ä‘á»•i, giá»¯ nguyÃªn -->
<style>
.policy-builder { background: #f8f9fa; padding: 25px; border-radius: 12px; margin: 20px 0; border: 1px solid #dee2e6; }
.attribute-group { margin-bottom: 20px; padding: 15px; background: #ffffff; border-radius: 8px; border: 1px solid #e9ecef; }
.attribute-group h4 { color: #2c3e50; margin-bottom: 10px; font-size: 1.1em; }
.attribute-selector { display: flex; flex-wrap: wrap; gap: 10px; }
.attribute-option { display: inline-block; padding: 8px 15px; border: 2px solid #ccc; border-radius: 20px; cursor: pointer; user-select: none; transition: all 0.2s ease-in-out; font-size: 0.9em; }
.attribute-option:hover { border-color: #3498db; background: #eaf5fc; }
.attribute-option.selected { background-color: #3498db; color: white; border-color: #2980b9; font-weight: 600; }
textarea#policy-expression { background-color: #f0f0f0; cursor: not-allowed; font-family: monospace; font-size: 1em; color: #333; }
.status-panel { background: #f8f9fa; border-left: 5px solid #27ae60; padding: 20px; margin: 20px 0; border-radius: 0 8px 8px 0; }
.status-panel ul { list-style-type: none; padding-left: 5px; }
.status-panel li { margin-top: 10px; }
</style>
{% endblock %}


{% block content %}
<h2>ğŸ“ Táº¡o vÃ  MÃ£ hÃ³a Há»“ sÆ¡ Bá»‡nh Ã¡n</h2>

<!-- ======================================================================= -->
<!-- LOGIC HIá»‚N THá»Š Dá»°A TRÃŠN BIáº¾N `step` Tá»ª FLASK -->
<!-- ======================================================================= -->

{% if step == 'prepare' or not step %}
    <!-- ==================== BÆ¯á»šC 1: FORM CHUáº¨N Bá»Š VÃ€ MÃƒ HÃ“A ==================== -->
    <form id="data-creator-form" action="{{ url_for('creator.encrypt') }}" method="POST" enctype="multipart/form-data">
        <h3>BÆ°á»›c 1: Chuáº©n bá»‹ vÃ  MÃ£ hÃ³a</h3>
        <p>Äiá»n thÃ´ng tin, chá»n file, xÃ¢y dá»±ng chÃ­nh sÃ¡ch vÃ  nháº¥n "MÃ£ hÃ³a". Dá»¯ liá»‡u sáº½ Ä‘Æ°á»£c mÃ£ hÃ³a an toÃ n trÃªn server.</p>

        <div class="form-group">
          <label for="patient_name">TÃªn Bá»‡nh nhÃ¢n</label>
          <input type="text" id="patient_name" name="patient_name" placeholder="VÃ­ dá»¥: Nguyá»…n VÄƒn A" required class="form-control" />
        </div>
        
        <div class="form-group">
          <label for="medical_file">Há»“ sÆ¡ y táº¿ (chá»n file)</label>
          <input type="file" id="medical_file" name="medical_file" accept=".txt,.pdf,.jpg,.png" required class="form-control" />
          <p id="file-name-display" style="margin-top: 5px; font-style: italic; color: #555;"></p>
        </div>
        
        <div class="form-group">
          <label for="public_key_file">Public Key cá»§a Há»‡ thá»‘ng (chá»n file .pk)</label>
          <input type="file" id="public_key_file" name="public_key_file" accept=".pk" required class="form-control" />
        </div>
        
        <!-- Policy Builder -->
        <div class="policy-builder">
            <h3>ğŸ”’ XÃ¢y dá»±ng ChÃ­nh sÃ¡ch Truy cáº­p (CP-ABE)</h3>
            <p>Chá»n cÃ¡c thuá»™c tÃ­nh. CÃ¡c thuá»™c tÃ­nh trong cÃ¹ng má»™t nhÃ³m sáº½ Ä‘Æ°á»£c káº¿t ná»‘i báº±ng toÃ¡n tá»­ `or`, giá»¯a cÃ¡c nhÃ³m khÃ¡c nhau sáº½ lÃ  `and`.</p>
            
            <div class="attribute-group">
                <h4>ğŸ‘¥ Vai trÃ² (chá»n Ã­t nháº¥t 1):</h4>
                <div class="attribute-selector">
                    <div class="attribute-option" data-group="role" data-policy="role:Doctor">ğŸ‘¨â€âš•ï¸ BÃ¡c sÄ©</div>
                    <div class="attribute-option" data-group="role" data-policy="role:Nurse">ğŸ‘©â€âš•ï¸ Y tÃ¡</div>
                    <div class="attribute-option" data-group="role" data-policy="role:Researcher">ğŸ”¬ NhÃ  nghiÃªn cá»©u</div>
                </div>
            </div>
            <div class="attribute-group">
                <h4>ğŸ¥ ChuyÃªn khoa (tÃ¹y chá»n):</h4>
                <div class="attribute-selector">
                    <div class="attribute-option" data-group="dept" data-policy="dept:Cardiology">â¤ï¸ Khoa Tim máº¡ch</div>
                    <div class="attribute-option" data-group="dept" data-policy="dept:Neurology">ğŸ§  Khoa Tháº§n kinh</div>
                    <div class="attribute-option" data-group="dept" data-policy="dept:Emergency">ğŸš¨ Khoa Cáº¥p cá»©u</div>
                </div>
            </div>

            <div class="form-group">
                <label for="policy-expression">ChÃ­nh sÃ¡ch Ä‘Æ°á»£c táº¡o (Read-only)</label>
                <textarea id="policy-expression" name="policy_expression" rows="3" placeholder="ChÃ­nh sÃ¡ch sáº½ hiá»‡n á»Ÿ Ä‘Ã¢y sau khi báº¡n nháº¥n nÃºt 'Táº¡o ChÃ­nh sÃ¡ch'" readonly required></textarea>
            </div>
            
            <button type="button" class="btn btn-primary" id="generate-policy-btn">âš™ï¸ Táº¡o ChÃ­nh sÃ¡ch</button>
            <button type="button" class="btn btn-danger" id="clear-all-btn">ğŸ—‘ï¸ XÃ³a lá»±a chá»n</button>
        </div>

        <button type="submit" class="btn btn-success" style="margin-top: 20px; width: 100%; padding: 15px; font-size: 1.2em;">ğŸ”’ Báº¯t Ä‘áº§u MÃ£ hÃ³a</button>
    </form>
{% endif %}


<!-- ======================================================================= -->
<!-- == PHáº¦N Bá»Š THIáº¾U ÄÃƒ ÄÆ¯á»¢C Bá»” SUNG Láº I Táº I ÄÃ‚Y == -->
<!-- ======================================================================= -->
{% if step == 'confirm' %}
    <!-- ==================== BÆ¯á»šC 2: FORM XÃC NHáº¬N VÃ€ UPLOAD ==================== -->
    <h3>BÆ°á»›c 2: XÃ¡c nháº­n vÃ  Táº£i lÃªn Cloud</h3>
    
    <div class="status-panel">
        <h4 style="color: #155724;">âœ… MÃ£ hÃ³a thÃ nh cÃ´ng!</h4>
        <p>CÃ¡c tá»‡p sau Ä‘Ã£ Ä‘Æ°á»£c táº¡o trÃªn server vÃ  sáºµn sÃ ng Ä‘á»ƒ táº£i lÃªn Cloud cho bá»‡nh nhÃ¢n <strong>{{ files.patient_name }}</strong>:</p>
        <ul>
            <li><strong>Báº£n mÃ£ há»“ sÆ¡:</strong> <code>{{ files.ciphertext_file }}</code></li>
            <li><strong>KhÃ³a mÃ£ hÃ³a:</strong> <code>{{ files.key_file }}</code></li>
            <li><strong>ChÃ­nh sÃ¡ch Ã¡p dá»¥ng:</strong> <code>{{ files.policy }}</code></li>
        </ul>
    </div>
    
    <form action="{{ url_for('creator.upload') }}" method="POST">
        <p>Nháº¥n nÃºt dÆ°á»›i Ä‘Ã¢y Ä‘á»ƒ hoÃ n táº¥t viá»‡c táº£i há»“ sÆ¡ Ä‘Ã£ mÃ£ hÃ³a lÃªn cÆ¡ sá»Ÿ dá»¯ liá»‡u trÃªn Cloud.</p>
        <button type="submit" class="btn btn-success" style="width: 100%; padding: 15px; font-size: 1.2em;">â˜ï¸ Táº£i lÃªn Cloud</button>
        <a href="{{ url_for('creator.data_creator') }}" class="btn btn-danger" style="width: 100%; padding: 15px; font-size: 1.2em; text-align: center;">Há»§y bá» vÃ  Báº¯t Ä‘áº§u láº¡i</a>
    </form>
{% endif %}

{% endblock %}


{% block scripts %}
<script>
// Chá» cho toÃ n bá»™ tÃ i liá»‡u HTML Ä‘Æ°á»£c táº£i xong rá»“i má»›i cháº¡y mÃ£ JS
document.addEventListener('DOMContentLoaded', function() {
  
  // --- Tá»± Ä‘á»™ng gáº¯n sá»± kiá»‡n cho cÃ¡c nÃºt chá»n thuá»™c tÃ­nh ---
  const attributeOptions = document.querySelectorAll('.attribute-option');
  attributeOptions.forEach(option => {
    option.addEventListener('click', function() {
      this.classList.toggle('selected');
    });
  });

  // --- Tá»± Ä‘á»™ng gáº¯n sá»± kiá»‡n cho nÃºt "Táº¡o ChÃ­nh sÃ¡ch" ---
  const generateBtn = document.getElementById('generate-policy-btn');
  if(generateBtn) {
      generateBtn.addEventListener('click', function() {
          const groups = {};
          const selectedElems = document.querySelectorAll('.attribute-option.selected');
          
          if (selectedElems.length === 0) {
              alert('Vui lÃ²ng chá»n Ã­t nháº¥t má»™t thuá»™c tÃ­nh!');
              return;
          }
          
          selectedElems.forEach(el => {
              const group = el.getAttribute('data-group');
              const policy = el.getAttribute('data-policy');
              if (!groups[group]) {
                  groups[group] = [];
              }
              groups[group].push(policy);
          });
          
          if (!groups.role || groups.role.length === 0) {
              alert('Báº¯t buá»™c pháº£i chá»n Ã­t nháº¥t má»™t thuá»™c tÃ­nh trong nhÃ³m "Vai trÃ²"!');
              return;
          }
          
          const policyParts = [];
          for (const policies of Object.values(groups)) {
              if (policies.length > 1) {
                  policyParts.push(`(${policies.join(' or ')})`);
              } else {
                  policyParts.push(policies[0]);
              }
          }
          
          const finalPolicy = policyParts.join(' and ');
          document.getElementById('policy-expression').value = finalPolicy;
          alert('âœ… ChÃ­nh sÃ¡ch Ä‘Ã£ Ä‘Æ°á»£c táº¡o thÃ nh cÃ´ng!');
      });
  }
  
  // --- Tá»± Ä‘á»™ng gáº¯n sá»± kiá»‡n cho nÃºt "XÃ³a lá»±a chá»n" ---
  const clearBtn = document.getElementById('clear-all-btn');
  if(clearBtn) {
      clearBtn.addEventListener('click', function() {
          document.querySelectorAll('.attribute-option.selected').forEach(el => el.classList.remove('selected'));
          document.getElementById('policy-expression').value = '';
      });
  }

  // --- Gáº¯n sá»± kiá»‡n kiá»ƒm tra form trÆ°á»›c khi gá»­i ---
  const mainForm = document.getElementById('data-creator-form');
  if (mainForm) {
      mainForm.addEventListener('submit', function(event) {
          const policyText = document.getElementById('policy-expression').value.trim();
          if (policyText.length === 0) {
              alert('Vui lÃ²ng "Táº¡o ChÃ­nh sÃ¡ch" trÆ°á»›c khi mÃ£ hÃ³a!');
              event.preventDefault(); // NgÄƒn form Ä‘Æ°á»£c gá»­i Ä‘i
          }
      });
  }

  // --- Hiá»ƒn thá»‹ tÃªn file Ä‘Ã£ chá»n ---
  const fileInput = document.getElementById('medical_file');
  const fileNameDisplay = document.getElementById('file-name-display');
  if (fileInput) {
      fileInput.addEventListener('change', function() {
          if (this.files.length > 0) {
              fileNameDisplay.textContent = `ÄÃ£ chá»n: ${this.files[0].name}`;
          } else {
              fileNameDisplay.textContent = '';
          }
      });
  }

});
</script>
{% endblock %}