{% extends "base.html" %}
{% block title %}Táº¡o & Upload Há»“ sÆ¡{% endblock %}

{% block head %}
<style>
/* ... ToÃ n bá»™ CSS khÃ´ng Ä‘á»•i ... */
.form-section {
    margin-bottom: 40px;
    border-bottom: 2px dashed #ccc;
    padding-bottom: 20px;
}
.form-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
}
.policy-builder { background: #f8f9fa; padding: 25px; border-radius: 12px; margin: 20px 0; border: 1px solid #dee2e6; }
.attribute-group { margin-bottom: 20px; padding: 15px; background: #ffffff; border-radius: 8px; border: 1px solid #e9ecef; }
.attribute-group h4 { color: #2c3e50; margin-bottom: 10px; font-size: 1.1em; }
.attribute-selector { display: flex; flex-wrap: wrap; gap: 10px; }
.attribute-option { display: inline-block; padding: 8px 15px; border: 2px solid #ccc; border-radius: 20px; cursor: pointer; user-select: none; transition: all 0.2s ease-in-out; font-size: 0.9em; }
.attribute-option:hover { border-color: #3498db; background: #eaf5fc; }
.attribute-option.selected { background-color: #3498db; color: white; border-color: #2980b9; font-weight: 600; }
.status-panel {
    background: #e8f5e9;
    border-left: 5px solid #4CAF50;
    padding: 15px;
    margin: 20px 0;
    border-radius: 4px;
}
</style>
{% endblock %}

{% block content %}
<h2>ğŸ“ Táº¡o vÃ  MÃ£ hÃ³a Há»“ sÆ¡ Bá»‡nh Ã¡n</h2>

<!-- ====================================================================== -->
<!-- ==================== BÆ¯á»šC 1: FORM MÃƒ HÃ“A Dá»® LIá»†U ==================== -->
<!-- ====================================================================== -->
<div class="form-section">
    <h3>BÆ°á»›c 1: MÃ£ hÃ³a Dá»¯ liá»‡u</h3>
    <p>Äiá»n thÃ´ng tin vÃ  chá»n cÃ¡c file cáº§n thiáº¿t. Sau khi nháº¥n "Báº¯t Ä‘áº§u MÃ£ hÃ³a", cÃ¡c file Ä‘Ã£ mÃ£ hÃ³a sáº½ Ä‘Æ°á»£c táº¡o trong thÆ° má»¥c <code>output/</code> trÃªn mÃ¡y cá»§a báº¡n.</p>
    
    <form id="encrypt-form" action="{{ url_for('creator.encrypt') }}" method="POST" enctype="multipart/form-data">
        <div class="form-group">
          <label for="patient_name">TÃªn Bá»‡nh nhÃ¢n</label>
          <input type="text" id="patient_name" name="patient_name" required class="form-control" />
        </div>
        <div class="form-group">
          <label for="medical_file">Há»“ sÆ¡ y táº¿</label>
          <input type="file" id="medical_file" name="medical_file" required class="form-control" />
        </div>
        <div class="form-group">
          <label for="public_key_file">Public Key</label>
          <input type="file" id="public_key_file" name="public_key_file" accept=".pk" required class="form-control" />
        </div>
        
        <!-- ======================================================== -->
        <!-- == POLICY BUILDER ÄÃƒ ÄÆ¯á»¢C THÃŠM Láº I == -->
        <!-- ======================================================== -->
        <div class="policy-builder">
            <h3>ğŸ”’ XÃ¢y dá»±ng ChÃ­nh sÃ¡ch Truy cáº­p</h3>
            <p>1. Chá»n cÃ¡c thuá»™c tÃ­nh. 2. Nháº¥n "Táº¡o & Táº£i vá» ChÃ­nh sÃ¡ch". 3. Chá»n láº¡i file vá»«a táº£i vá» á»Ÿ Ã´ bÃªn dÆ°á»›i.</p>
            
            <div class="attribute-group">
                <h4>ğŸ‘¥ Vai trÃ² (chá»n Ã­t nháº¥t 1):</h4>
                <div class="attribute-selector">
                    <div class="attribute-option" data-group="role" data-policy="role:Doctor">ğŸ‘¨â€âš•ï¸ BÃ¡c sÄ©</div>
                    <div class="attribute-option" data-group="role" data-policy="role:Nurse">ğŸ‘©â€âš•ï¸ Y tÃ¡</div>
                    <div class="attribute-option" data-group="role" data-policy="role:Researcher">ğŸ”¬ NhÃ  nghiÃªn cá»©u</div>
                </div>
            </div>
            <div class="attribute-group">
                <h4>ğŸ¥ ChuyÃªn khoa (tÃ¹y chá»n):</h4>
                <div class="attribute-selector">
                    <div class="attribute-option" data-group="dept" data-policy="dept:Cardiology">â¤ï¸ Khoa Tim máº¡ch</div>
                    <div class="attribute-option" data-group="dept" data-policy="dept:Neurology">ğŸ§  Khoa Tháº§n kinh</div>
                    <div class="attribute-option" data-group="dept" data-policy="dept:Emergency">ğŸš¨ Khoa Cáº¥p cá»©u</div>
                </div>
            </div>

            <button type="button" class="btn btn-primary" id="generate-policy-btn">âš™ï¸ Táº¡o & Táº£i vá» ChÃ­nh sÃ¡ch</button>
            <button type="button" class="btn btn-danger" id="clear-all-btn">ğŸ—‘ï¸ XÃ³a lá»±a chá»n</button>
        </div>

        <div class="form-group">
          <label for="policy_file">File ChÃ­nh sÃ¡ch (chá»n file <code>access_policy.txt</code> vá»«a táº£i vá»)</label>
          <input type="file" id="policy_file" name="policy_file" accept=".txt" required class="form-control" />
        </div>
        
        <button type="submit" class="btn btn-primary" style="width: 100%;">ğŸ”’ Báº¯t Ä‘áº§u MÃ£ hÃ³a</button>
    </form>
</div>

<!-- ====================================================================== -->
<!-- ==================== BÆ¯á»šC 2: FORM UPLOAD Dá»® LIá»†U ===================== -->
<!-- ====================================================================== -->
<div class="form-section">
    <h3>BÆ°á»›c 2: Táº£i lÃªn Cloud</h3>
    
    {% if step == 'confirm' %}
    <div class="status-panel">
        <h4>âœ… MÃ£ hÃ³a thÃ nh cÃ´ng!</h4>
        <p>CÃ¡c tá»‡p Ä‘Ã£ Ä‘Æ°á»£c táº¡o trong thÆ° má»¥c <strong>output/</strong>. BÃ¢y giá», hÃ£y chá»n láº¡i chÃºng Ä‘á»ƒ táº£i lÃªn Cloud cho bá»‡nh nhÃ¢n <strong>{{ info.patient_name }}</strong>.</p>
    </div>
    {% else %}
    <p>Sau khi hoÃ n thÃ nh BÆ°á»›c 1, hÃ£y chá»n cÃ¡c file Ä‘Ã£ Ä‘Æ°á»£c mÃ£ hÃ³a tá»« thÆ° má»¥c <code>output/</code> cá»§a báº¡n vÃ o cÃ¡c Ã´ tÆ°Æ¡ng á»©ng dÆ°á»›i Ä‘Ã¢y.</p>
    {% endif %}

    <form id="upload-form" action="{{ url_for('creator.upload') }}" method="POST" enctype="multipart/form-data">
        <div class="form-group">
          <label for="ciphertext_file_upload">1. Chá»n láº¡i File Báº£n mÃ£ Há»“ sÆ¡ (<code>output/ciphertext.bin</code>)</label>
          <input type="file" id="ciphertext_file_upload" name="ciphertext_file_upload" accept=".bin" required class="form-control" />
        </div>
        <div class="form-group">
          <label for="key_file_upload">2. Chá»n láº¡i File KhÃ³a Ä‘Ã£ mÃ£ hÃ³a (<code>output/aes_key_cpabe.ct</code>)</label>
          <input type="file" id="key_file_upload" name="key_file_upload" accept=".ct" required class="form-control" />
        </div>
        
        <button type="submit" class="btn btn-success" style="width: 100%;">ğŸš€ Táº£i lÃªn Cloud</button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
// Chá» cho toÃ n bá»™ tÃ i liá»‡u HTML Ä‘Æ°á»£c táº£i xong rá»“i má»›i cháº¡y mÃ£ JS
document.addEventListener('DOMContentLoaded', function() {
  
  // Tá»± Ä‘á»™ng gáº¯n sá»± kiá»‡n cho cÃ¡c nÃºt chá»n thuá»™c tÃ­nh
  document.querySelectorAll('.attribute-option').forEach(option => {
    option.addEventListener('click', function() { this.classList.toggle('selected'); });
  });

  // Tá»± Ä‘á»™ng gáº¯n sá»± kiá»‡n cho nÃºt "XÃ³a lá»±a chá»n"
  document.getElementById('clear-all-btn').addEventListener('click', function() {
      document.querySelectorAll('.attribute-option.selected').forEach(el => el.classList.remove('selected'));
  });

  // LOGIC CHO NÃšT Táº O CHÃNH SÃCH
  document.getElementById('generate-policy-btn').addEventListener('click', function() {
      const selectedElems = document.querySelectorAll('.attribute-option.selected');
      if (selectedElems.length === 0) {
          alert('Vui lÃ²ng chá»n Ã­t nháº¥t má»™t thuá»™c tÃ­nh Ä‘á»ƒ táº¡o chÃ­nh sÃ¡ch!');
          return;
      }

      const form = document.createElement('form');
      form.method = 'POST';
      form.action = "{{ url_for('creator.generate_policy') }}";
      
      selectedElems.forEach(el => {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'policies';
          input.value = el.getAttribute('data-policy') + '|' + el.getAttribute('data-group');
          form.appendChild(input);
      });

      document.body.appendChild(form);
      form.submit();
      document.body.removeChild(form);
  });
});
</script>
{% endblock %}