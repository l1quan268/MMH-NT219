{% extends "base.html" %}
{% block title %}Tạo & Upload Hồ sơ{% endblock %}

{% block head %}
<style>
/* ... Toàn bộ CSS không đổi ... */
.form-section {
    margin-bottom: 40px;
    border-bottom: 2px dashed #ccc;
    padding-bottom: 20px;
}
.form-section:last-child {
    border-bottom: none;
    margin-bottom: 0;
}
.policy-builder { background: #f8f9fa; padding: 25px; border-radius: 12px; margin: 20px 0; border: 1px solid #dee2e6; }
.attribute-group { margin-bottom: 20px; padding: 15px; background: #ffffff; border-radius: 8px; border: 1px solid #e9ecef; }
.attribute-group h4 { color: #2c3e50; margin-bottom: 10px; font-size: 1.1em; }
.attribute-selector { display: flex; flex-wrap: wrap; gap: 10px; }
.attribute-option { display: inline-block; padding: 8px 15px; border: 2px solid #ccc; border-radius: 20px; cursor: pointer; user-select: none; transition: all 0.2s ease-in-out; font-size: 0.9em; }
.attribute-option:hover { border-color: #3498db; background: #eaf5fc; }
.attribute-option.selected { background-color: #3498db; color: white; border-color: #2980b9; font-weight: 600; }
.status-panel {
    background: #e8f5e9;
    border-left: 5px solid #4CAF50;
    padding: 15px;
    margin: 20px 0;
    border-radius: 4px;
}
</style>
{% endblock %}

{% block content %}
<h2>📝 Tạo và Mã hóa Hồ sơ Bệnh án</h2>

<!-- ====================================================================== -->
<!-- ==================== BƯỚC 1: FORM MÃ HÓA DỮ LIỆU ==================== -->
<!-- ====================================================================== -->
<div class="form-section">
    <h3>Bước 1: Mã hóa Dữ liệu</h3>
    <p>Điền thông tin và chọn các file cần thiết. Sau khi nhấn "Bắt đầu Mã hóa", các file đã mã hóa sẽ được tạo trong thư mục <code>output/</code> trên máy của bạn.</p>
    
    <form id="encrypt-form" action="{{ url_for('creator.encrypt') }}" method="POST" enctype="multipart/form-data">
        <div class="form-group">
          <label for="patient_name">Tên Bệnh nhân</label>
          <input type="text" id="patient_name" name="patient_name" required class="form-control" />
        </div>
        <div class="form-group">
          <label for="medical_file">Hồ sơ y tế</label>
          <input type="file" id="medical_file" name="medical_file" required class="form-control" />
        </div>
        <div class="form-group">
          <label for="public_key_file">Public Key</label>
          <input type="file" id="public_key_file" name="public_key_file" accept=".pk" required class="form-control" />
        </div>
        
        <!-- ======================================================== -->
        <!-- == POLICY BUILDER ĐÃ ĐƯỢC THÊM LẠI == -->
        <!-- ======================================================== -->
        <div class="policy-builder">
            <h3>🔒 Xây dựng Chính sách Truy cập</h3>
            <p>1. Chọn các thuộc tính. 2. Nhấn "Tạo & Tải về Chính sách". 3. Chọn lại file vừa tải về ở ô bên dưới.</p>
            
            <div class="attribute-group">
                <h4>👥 Vai trò (chọn ít nhất 1):</h4>
                <div class="attribute-selector">
                    <div class="attribute-option" data-group="role" data-policy="role:Doctor">👨‍⚕️ Bác sĩ</div>
                    <div class="attribute-option" data-group="role" data-policy="role:Nurse">👩‍⚕️ Y tá</div>
                    <div class="attribute-option" data-group="role" data-policy="role:Researcher">🔬 Nhà nghiên cứu</div>
                </div>
            </div>
            <div class="attribute-group">
                <h4>🏥 Chuyên khoa (tùy chọn):</h4>
                <div class="attribute-selector">
                    <div class="attribute-option" data-group="dept" data-policy="dept:Cardiology">❤️ Khoa Tim mạch</div>
                    <div class="attribute-option" data-group="dept" data-policy="dept:Neurology">🧠 Khoa Thần kinh</div>
                    <div class="attribute-option" data-group="dept" data-policy="dept:Emergency">🚨 Khoa Cấp cứu</div>
                </div>
            </div>

            <button type="button" class="btn btn-primary" id="generate-policy-btn">⚙️ Tạo & Tải về Chính sách</button>
            <button type="button" class="btn btn-danger" id="clear-all-btn">🗑️ Xóa lựa chọn</button>
        </div>

        <div class="form-group">
          <label for="policy_file">File Chính sách (chọn file <code>access_policy.txt</code> vừa tải về)</label>
          <input type="file" id="policy_file" name="policy_file" accept=".txt" required class="form-control" />
        </div>
        
        <button type="submit" class="btn btn-primary" style="width: 100%;">🔒 Bắt đầu Mã hóa</button>
    </form>
</div>

<!-- ====================================================================== -->
<!-- ==================== BƯỚC 2: FORM UPLOAD DỮ LIỆU ===================== -->
<!-- ====================================================================== -->
<div class="form-section">
    <h3>Bước 2: Tải lên Cloud</h3>
    
    {% if step == 'confirm' %}
    <div class="status-panel">
        <h4>✅ Mã hóa thành công!</h4>
        <p>Các tệp đã được tạo trong thư mục <strong>output/</strong>. Bây giờ, hãy chọn lại chúng để tải lên Cloud cho bệnh nhân <strong>{{ info.patient_name }}</strong>.</p>
    </div>
    {% else %}
    <p>Sau khi hoàn thành Bước 1, hãy chọn các file đã được mã hóa từ thư mục <code>output/</code> của bạn vào các ô tương ứng dưới đây.</p>
    {% endif %}

    <form id="upload-form" action="{{ url_for('creator.upload') }}" method="POST" enctype="multipart/form-data">
        <div class="form-group">
          <label for="ciphertext_file_upload">1. Chọn lại File Bản mã Hồ sơ (<code>output/ciphertext.bin</code>)</label>
          <input type="file" id="ciphertext_file_upload" name="ciphertext_file_upload" accept=".bin" required class="form-control" />
        </div>
        <div class="form-group">
          <label for="key_file_upload">2. Chọn lại File Khóa đã mã hóa (<code>output/aes_key_cpabe.ct</code>)</label>
          <input type="file" id="key_file_upload" name="key_file_upload" accept=".ct" required class="form-control" />
        </div>
        
        <button type="submit" class="btn btn-success" style="width: 100%;">🚀 Tải lên Cloud</button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
// Chờ cho toàn bộ tài liệu HTML được tải xong rồi mới chạy mã JS
document.addEventListener('DOMContentLoaded', function() {
  
  // Tự động gắn sự kiện cho các nút chọn thuộc tính
  document.querySelectorAll('.attribute-option').forEach(option => {
    option.addEventListener('click', function() { this.classList.toggle('selected'); });
  });

  // Tự động gắn sự kiện cho nút "Xóa lựa chọn"
  document.getElementById('clear-all-btn').addEventListener('click', function() {
      document.querySelectorAll('.attribute-option.selected').forEach(el => el.classList.remove('selected'));
  });

  // LOGIC CHO NÚT TẠO CHÍNH SÁCH
  document.getElementById('generate-policy-btn').addEventListener('click', function() {
      const selectedElems = document.querySelectorAll('.attribute-option.selected');
      if (selectedElems.length === 0) {
          alert('Vui lòng chọn ít nhất một thuộc tính để tạo chính sách!');
          return;
      }

      const form = document.createElement('form');
      form.method = 'POST';
      form.action = "{{ url_for('creator.generate_policy') }}";
      
      selectedElems.forEach(el => {
          const input = document.createElement('input');
          input.type = 'hidden';
          input.name = 'policies';
          input.value = el.getAttribute('data-policy') + '|' + el.getAttribute('data-group');
          form.appendChild(input);
      });

      document.body.appendChild(form);
      form.submit();
      document.body.removeChild(form);
  });
});
</script>
{% endblock %}