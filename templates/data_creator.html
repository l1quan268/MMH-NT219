{% extends "base.html" %}
{% block title %}T·∫°o H·ªì s∆° B·ªánh √°n{% endblock %}

{% block head %}
<style>
.form-section { margin-bottom: 30px; padding-bottom: 30px; border-bottom: 2px dashed #ccc; }
.form-section:last-child { border-bottom: none; padding-bottom: 0; margin-bottom: 0; }
.search-area { display: flex; gap: 10px; align-items: center; }
#encryption-section, #upload-section { transition: opacity 0.5s ease; }
.policy-builder { background: #f8f9fa; padding: 25px; border-radius: 12px; margin: 20px 0; border: 1px solid #dee2e6; }
.attribute-group { margin-bottom: 20px; padding: 15px; background: #ffffff; border-radius: 8px; border: 1px solid #e9ecef; }
.attribute-group h4 { color: #2c3e50; margin-bottom: 10px; font-size: 1.1em; }
.attribute-selector { display: flex; flex-wrap: wrap; gap: 10px; }
.attribute-option { display: inline-block; padding: 8px 15px; border: 2px solid #ccc; border-radius: 20px; cursor: pointer; user-select: none; transition: all 0.2s ease-in-out; font-size: 0.9em; }
.attribute-option:hover { border-color: #3498db; background: #eaf5fc; }
.attribute-option.selected { background-color: #3498db; color: white; border-color: #2980b9; font-weight: 600; }
.status-panel { background: #e8f5e9; padding: 15px; margin: 20px 0; border-radius: 4px; border-left: 5px solid #4CAF50;}
.attribute-option[data-policy="role:Patient"] { border-style: dashed; border-color: #28a745; }
.attribute-option[data-policy="role:Patient"].selected { background-color: #28a745; border-color: #1e7e34; }
.alert { padding: 10px; border-radius: 5px; }
.alert-success { background-color: #d4edda; color: #155724; }
.alert-danger { background-color: #f8d7da; color: #721c24; }
</style>
{% endblock %}

{% block content %}
<h2>üìù T·∫°o H·ªì s∆° cho B·ªánh nh√¢n</h2>

<!-- B∆Ø·ªöC 1: T√åM KI·∫æM B·ªÜNH NH√ÇN -->
<div class="form-section">
    <h3>B∆∞·ªõc 1: T√¨m ki·∫øm B·ªánh nh√¢n</h3>
    <p>Nh·∫≠p s·ªë CCCD/National ID c·ªßa b·ªánh nh√¢n ƒë·ªÉ x√°c ƒë·ªãnh v√† li√™n k·∫øt h·ªì s∆°.</p>
    <div class="form-group">
        <label for="search_national_id">CCCD / National ID</label>
        <div class="search-area">
            <input type="text" id="search_national_id" class="form-control" placeholder="Nh·∫≠p s·ªë CCCD c·ªßa b·ªánh nh√¢n...">
            <button type="button" class="btn btn-primary" id="search-patient-btn" style="flex-shrink: 0;">üîç T√¨m</button>
        </div>
    </div>
    <div id="search-result" style="margin-top: 15px;"></div>
</div>

<!-- B∆Ø·ªöC 2: FORM M√É H√ìA -->
<div id="encryption-section" class="form-section" style="opacity: 0.5; pointer-events: none;">
    <form id="encrypt-form" action="{{ url_for('creator.encrypt') }}" method="POST" enctype="multipart/form-data">
        <h3>B∆∞·ªõc 2: Chu·∫©n b·ªã v√† M√£ h√≥a</h3>
        <input type="hidden" id="patient_id" name="patient_id">
        <input type="hidden" id="patient_name" name="patient_name">
        <div class="form-group">
            <label for="medical_file">H·ªì s∆° y t·∫ø</label>
            <input type="file" id="medical_file" name="medical_file" required class="form-control" />
        </div>
        <div class="form-group">
            <label for="public_key_file">Public Key</label>
            <input type="file" id="public_key_file" name="public_key_file" accept=".pk" required class="form-control" />
        </div>
        <div class="form-group">
            <label for="aes_key_file">File Kh√≥a AES (T√πy ch·ªçn)</label>
            <input type="file" id="aes_key_file" name="aes_key_file" accept=".key" class="form-control" />
            <p style="font-size: 0.9em; color: #666;">ƒê·ªÉ tr·ªëng n·∫øu mu·ªën h·ªá th·ªëng t·ª± t·∫°o kh√≥a ng·∫´u nhi√™n (khuy·∫øn ngh·ªã).</p>
        </div>
        <div class="policy-builder">
            <h3>üîí X√¢y d·ª±ng & T·∫£i v·ªÅ Ch√≠nh s√°ch</h3>
            <p>1. Ch·ªçn thu·ªôc t√≠nh. 2. Nh·∫•n "T·∫°o & T·∫£i v·ªÅ". 3. Ch·ªçn l·∫°i file ·ªü √¥ d∆∞·ªõi.</p>
            <div class="attribute-group">
                <h4>üë• Vai tr√≤ ƒë∆∞·ª£c ph√©p truy c·∫≠p:</h4>
                <div class="attribute-selector">
                    <div class="attribute-option" data-group="role" data-policy="role:Doctor">üë®‚Äç‚öïÔ∏è B√°c sƒ©</div>
                    <div class="attribute-option" data-group="role" data-policy="role:Patient">üë§ B·ªánh nh√¢n</div>
                </div>
            </div>
            <div class="attribute-group">
                <h4>üè• Chuy√™n khoa (√°p d·ª•ng cho B√°c sƒ©):</h4>
                <div class="attribute-selector">
                    <div class="attribute-option" data-group="dept" data-policy="dept:Cardiology">‚ù§Ô∏è Khoa Tim m·∫°ch</div>
                    <div class="attribute-option" data-group="dept" data-policy="dept:Neurology">üß† Khoa Th·∫ßn kinh</div>
                </div>
            </div>
            <button type="button" class="btn btn-primary" id="generate-policy-btn">‚öôÔ∏è T·∫°o & T·∫£i v·ªÅ Ch√≠nh s√°ch</button>
            <button type="button" class="btn btn-danger" id="clear-all-btn">üóëÔ∏è X√≥a l·ª±a ch·ªçn</button>
        </div>
        <div class="form-group">
            <label for="policy_file">File Ch√≠nh s√°ch (ch·ªçn l·∫°i file <code>.txt</code>)</label>
            <input type="file" id="policy_file" name="policy_file" accept=".txt" required class="form-control" />
        </div>
        <button type="submit" class="btn btn-success" style="width: 100%;">üîí M√£ h√≥a v√† T·∫°o file Output</button>
    </form>
</div>

<!-- ======================================================== -->
<!-- == B∆Ø·ªöC 3 ƒê√É ƒê∆Ø·ª¢C TH√äM L·∫†I V√ÄO ƒê√ÇY == -->
<!-- ======================================================== -->
{% if step == 'confirm' %}
<div id="upload-section" class="form-section">
    <h3>B∆∞·ªõc 3: T·∫£i l√™n Cloud</h3>
    <div class="status-panel">
        <h4>‚úÖ M√£ h√≥a th√†nh c√¥ng!</h4>
        <p>C√°c t·ªáp ƒë√£ ƒë∆∞·ª£c t·∫°o trong <strong>output/</strong>. B√¢y gi·ªù, h√£y ch·ªçn l·∫°i ch√∫ng ƒë·ªÉ t·∫£i l√™n Cloud cho <strong>{{ info.patient_name }}</strong>.</p>
    </div>
    <form id="upload-form" action="{{ url_for('creator.upload') }}" method="POST" enctype="multipart/form-data">
        <div class="form-group">
            <label for="ciphertext_file_upload">1. Ch·ªçn l·∫°i File B·∫£n m√£ (<code>output/ciphertext.bin</code>)</label>
            <input type="file" id="ciphertext_file_upload" name="ciphertext_file_upload" accept=".bin" required class="form-control" />
        </div>
        <div class="form-group">
            <label for="key_file_upload">2. Ch·ªçn l·∫°i File Kh√≥a (<code>output/aes_key_cpabe.ct</code>)</label>
            <input type="file" id="key_file_upload" name="key_file_upload" accept=".ct" required class="form-control" />
        </div>
        <button type="submit" class="btn btn-success" style="width: 100%;">üöÄ T·∫£i l√™n Cloud</button>
    </form>
</div>
{% endif %}

{% endblock %}


{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    // ---- LOGIC T√åM KI·∫æM B·ªÜNH NH√ÇN (Kh√¥ng ƒë·ªïi) ----
    const searchBtn = document.getElementById('search-patient-btn');
    const searchInput = document.getElementById('search_national_id');
    const searchResultDiv = document.getElementById('search-result');
    const encryptionSection = document.getElementById('encryption-section');
    const patientIdInput = document.getElementById('patient_id');
    const patientNameInput = document.getElementById('patient_name');

    searchBtn.addEventListener('click', function() {
        const nationalId = searchInput.value.trim();
        if (!nationalId) {
            alert('Vui l√≤ng nh·∫≠p CCCD ƒë·ªÉ t√¨m ki·∫øm.');
            return;
        }
        searchResultDiv.innerHTML = '<p>ƒêang t√¨m ki·∫øm...</p>';

        fetch("{{ url_for('creator.search_patient') }}", {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({ national_id: nationalId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.found) {
                searchResultDiv.innerHTML = `<div class="alert alert-success">‚úÖ T√¨m th·∫•y b·ªánh nh√¢n: <strong>${data.full_name}</strong></div>`;
                encryptionSection.style.opacity = '1';
                encryptionSection.style.pointerEvents = 'auto';
                patientIdInput.value = data.patient_id;
                patientNameInput.value = data.full_name;
            } else {
                searchResultDiv.innerHTML = `<div class="alert alert-danger">‚ùå ${data.message}</div>`;
                encryptionSection.style.opacity = '0.5';
                encryptionSection.style.pointerEvents = 'none';
                patientIdInput.value = '';
                patientNameInput.value = '';
            }
        })
        .catch(error => {
            console.error('L·ªói:', error);
            searchResultDiv.innerHTML = `<div class="alert alert-danger">C√≥ l·ªói x·∫£y ra khi t√¨m ki·∫øm.</div>`;
        });
    });

    // ---- LOGIC POLICY BUILDER (ƒê√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t) ----
    document.querySelectorAll('.attribute-option').forEach(option => {
        option.addEventListener('click', function() { this.classList.toggle('selected'); });
    });
    document.getElementById('clear-all-btn').addEventListener('click', function() {
        document.querySelectorAll('.attribute-option.selected').forEach(el => el.classList.remove('selected'));
    });

    document.getElementById('generate-policy-btn').addEventListener('click', function() {
        const selectedElems = document.querySelectorAll('.attribute-option.selected');
        if (selectedElems.length === 0) {
            alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt vai tr√≤!');
            return;
        }

        let isPatientSelected = false;
        const doctorPolicies = {};

        // Ph√¢n lo·∫°i c√°c thu·ªôc t√≠nh ƒë√£ ch·ªçn
        selectedElems.forEach(el => {
            const policy = el.getAttribute('data-policy');
            if (policy === 'role:Patient') {
                isPatientSelected = true;
            } else {
                const group = el.getAttribute('data-group');
                if (!doctorPolicies[group]) {
                    doctorPolicies[group] = [];
                }
                doctorPolicies[group].push(policy);
            }
        });

        let finalPolicy = "";
        const doctorPolicyParts = [];

        // X√¢y d·ª±ng ph·∫ßn ch√≠nh s√°ch cho b√°c sƒ© (n·∫øu c√≥)
        if (Object.keys(doctorPolicies).length > 0) {
             if (!doctorPolicies.role || doctorPolicies.role.length === 0) {
                alert('N·∫øu ch·ªçn c√°c thu·ªôc t√≠nh kh√°c (nh∆∞ chuy√™n khoa), b·∫°n ph·∫£i ch·ªçn vai tr√≤ "B√°c sƒ©"!');
                return;
            }
            // S·∫Øp x·∫øp c√°c nh√≥m ƒë·ªÉ c√≥ th·ª© t·ª± nh·∫•t qu√°n (dept, role)
            const sortedGroups = Object.keys(doctorPolicies).sort(); 
            for (const groupName of sortedGroups) {
                const policies = doctorPolicies[groupName];
                if (policies.length > 1) {
                    doctorPolicyParts.push(`(${policies.join(' or ')})`);
                } else {
                    doctorPolicyParts.push(policies[0]);
                }
            }
        }
        
        const doctorPolicyString = doctorPolicyParts.join(' and ');

        // K·∫øt h·ª£p c√°c ch√≠nh s√°ch l·∫°i theo logic OR ƒë·∫∑c bi·ªát
        if (isPatientSelected) {
            if (doctorPolicyString) {
                finalPolicy = `(${doctorPolicyString}) or role:Patient`;
            } else {
                finalPolicy = 'role:Patient';
            }
        } else {
            if (doctorPolicyString) {
                finalPolicy = doctorPolicyString;
            } else {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt vai tr√≤ (B√°c sƒ© ho·∫∑c B·ªánh nh√¢n)!');
                return;
            }
        }
        
        // T·∫°o form ·∫©n v√† g·ª≠i ƒëi ƒë·ªÉ t·∫£i file
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = "{{ url_for('creator.generate_policy') }}";
        const input = document.createElement('input');
        input.type = 'hidden';
        input.name = 'policy_string';
        input.value = finalPolicy;
        form.appendChild(input);
        
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
    });
});
</script>
{% endblock %}