{% extends "base.html" %}
{% block title %}T·∫£i l√™n H·ªì s∆° C√° nh√¢n{% endblock %}

{% block head %}
<style>
/* CSS kh√¥ng ƒë·ªïi */
.form-section { margin-bottom: 40px; padding-bottom: 20px; border-bottom: 2px dashed #ccc; }
.form-section:last-child { border-bottom: none; }
.policy-builder { background: #f8f9fa; padding: 25px; border-radius: 12px; margin: 20px 0; border: 1px solid #dee2e6; }
.attribute-group { margin-bottom: 20px; padding: 15px; background: #ffffff; border-radius: 8px; border: 1px solid #e9ecef; }
.attribute-group h4 { color: #2c3e50; margin-bottom: 10px; font-size: 1.1em; }
.attribute-selector { display: flex; flex-wrap: wrap; gap: 10px; }
.attribute-option { display: inline-block; padding: 8px 15px; border: 2px solid #ccc; border-radius: 20px; cursor: pointer; user-select: none; }
.attribute-option.selected { background-color: #3498db; color: white; border-color: #2980b9; }
textarea#policy_expression { background-color: #e9ecef; font-family: monospace;}
.status-panel { background: #e8f5e9; padding: 15px; margin: 20px 0; border-radius: 4px; border-left: 5px solid #4CAF50;}
</style>
{% endblock %}


{% block content %}
<h2>üìÅ T·∫£i l√™n H·ªì s∆° S·ª©c kh·ªèe C√° nh√¢n</h2>

<!-- ==================== B∆Ø·ªöC 1: FORM M√É H√ìA ==================== -->
{% if step == 'prepare' or not step %}
<div class="form-section">
    <h3>B∆∞·ªõc 1: Chu·∫©n b·ªã v√† M√£ h√≥a</h3>
    <p>Ch·ªçn h·ªì s∆° c·ªßa b·∫°n, x√¢y d·ª±ng ch√≠nh s√°ch truy c·∫≠p, sau ƒë√≥ nh·∫•n "M√£ h√≥a" ƒë·ªÉ t·∫°o c√°c file an to√†n trong th∆∞ m·ª•c <code>output/</code>.</p>
    
    <form id="encrypt-form" action="{{ url_for('user.patient_upload') }}" method="POST" enctype="multipart/form-data" onsubmit="return validateForm()">
        <div class="form-group">
          <label for="record_description">M√¥ t·∫£ h·ªì s∆°</label>
          <input type="text" id="record_description" name="record_description" required class="form-control" />
        </div>
        <div class="form-group">
          <label for="medical_file">File h·ªì s∆°</label>
          <input type="file" id="medical_file" name="medical_file" required class="form-control" />
        </div>
        <div class="form-group">
          <label for="public_key_file">Ch·ªçn Public Key c·ªßa H·ªá th·ªëng</label>
          <input type="file" id="public_key_file" name="public_key_file" accept=".pk" required class="form-control" />
        </div>
        
        <div class="policy-builder">
            <h3>üîí X√¢y d·ª±ng Ch√≠nh s√°ch Truy c·∫≠p</h3>
            <div class="attribute-group">
                <h4>üë• Vai tr√≤ (ch·ªçn √≠t nh·∫•t 1):</h4>
                <div class="attribute-selector">
                    <div class="attribute-option" data-group="role" data-policy="role:Doctor">üë®‚Äç‚öïÔ∏è B√°c sƒ©</div>
                    <div class="attribute-option" data-group="role" data-policy="role:Patient">üë§ Ch√≠nh b·∫°n</div>
                </div>
            </div>
            <div class="attribute-group">
                <h4>üè• Chuy√™n khoa (t√πy ch·ªçn):</h4>
                <div class="attribute-selector">
                    <div class="attribute-option" data-group="dept" data-policy="dept:Cardiology">‚ù§Ô∏è Khoa Tim m·∫°ch</div>
                </div>
            </div>
            <button type="button" class="btn btn-primary" id="generate-policy-btn">‚öôÔ∏è T·∫°o Ch√≠nh s√°ch</button>
            <button type="button" class="btn btn-danger" id="clear-all-btn">üóëÔ∏è X√≥a</button>
        </div>
        <div class="form-group">
          <label for="policy_expression">Ch√≠nh s√°ch ƒë∆∞·ª£c t·∫°o (b·∫Øt bu·ªôc)</label>
          <textarea id="policy_expression" name="policy_expression" rows="2" readonly required class="form-control"></textarea>
        </div>
        
        <button type="submit" class="btn btn-success" style="width: 100%;">üîí M√£ h√≥a v√† T·∫°o file Output</button>
    </form>
</div>
{% endif %}

<!-- ======================================================== -->
<!-- == B∆Ø·ªöC 2 ƒê√É ƒê∆Ø·ª¢C TH√äM L·∫†I V√ÄO ƒê√ÇY == -->
<!-- ======================================================== -->
{% if step == 'confirm' %}
<div class="form-section">
    <h3>B∆∞·ªõc 2: T·∫£i l√™n Cloud</h3>
    <div class="status-panel">
        <h4>‚úÖ M√£ h√≥a th√†nh c√¥ng!</h4>
        <p>C√°c t·ªáp ƒë√£ ƒë∆∞·ª£c t·∫°o trong th∆∞ m·ª•c <strong>output/</strong>. B√¢y gi·ªù, h√£y ch·ªçn l·∫°i ch√∫ng ƒë·ªÉ t·∫£i l√™n.</p>
    </div>
    <form id="upload-confirm-form" action="{{ url_for('user.patient_do_upload') }}" method="POST" enctype="multipart/form-data">
        <div class="form-group">
            <label>1. Ch·ªçn l·∫°i File B·∫£n m√£ (<code>output/patient_ciphertext.bin</code>)</label>
            <input type="file" name="ciphertext_file_upload" accept=".bin" required class="form-control" />
        </div>
        <div class="form-group">
            <label>2. Ch·ªçn l·∫°i File Kh√≥a (<code>output/patient_aes_key_cpabe.ct</code>)</label>
            <input type="file" name="key_file_upload" accept=".ct" required class="form-control" />
        </div>
        <button type="submit" class="btn btn-success" style="width: 100%;">üöÄ T·∫£i l√™n Cloud</button>
        <a href="{{ url_for('user.patient_upload') }}" class="btn btn-danger">H·ªßy b·ªè</a>
    </form>
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
// JavaScript cho Policy Builder (kh√¥ng ƒë·ªïi)
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.attribute-option').forEach(option => {
        option.addEventListener('click', function() { this.classList.toggle('selected'); });
    });

    document.getElementById('clear-all-btn').addEventListener('click', function() {
        document.querySelectorAll('.attribute-option.selected').forEach(el => el.classList.remove('selected'));
        document.getElementById('policy_expression').value = '';
    });

    document.getElementById('generate-policy-btn').addEventListener('click', function() {
        // ... (Logic t·∫°o ch√≠nh s√°ch ƒë·∫∑c bi·ªát or role:Patient gi·ªØ nguy√™n) ...
        let isPatientSelected = false;
        const doctorPolicies = {};
        const selectedElems = document.querySelectorAll('.attribute-option.selected');
        if (selectedElems.length === 0) {
            alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt vai tr√≤!');
            return;
        }
        selectedElems.forEach(el => {
            const policy = el.getAttribute('data-policy');
            if (policy === 'role:Patient') {
                isPatientSelected = true;
            } else {
                const group = el.getAttribute('data-group');
                if (!doctorPolicies[group]) { doctorPolicies[group] = []; }
                doctorPolicies[group].push(policy);
            }
        });
        
        let finalPolicy = "";
        const doctorPolicyParts = [];
        if (Object.keys(doctorPolicies).length > 0) {
             if (!doctorPolicies.role || doctorPolicies.role.length === 0) {
                alert('N·∫øu ch·ªçn c√°c thu·ªôc t√≠nh kh√°c, b·∫°n ph·∫£i ch·ªçn vai tr√≤ "B√°c sƒ©"!');
                return;
            }
            const sortedGroups = Object.keys(doctorPolicies).sort();
            for (const groupName of sortedGroups) {
                const policies = doctorPolicies[groupName];
                if (policies.length > 1) {
                    doctorPolicyParts.push(`(${policies.join(' or ')})`);
                } else {
                    doctorPolicyParts.push(policies[0]);
                }
            }
        }
        const doctorPolicyString = doctorPolicyParts.join(' and ');

        if (isPatientSelected) {
            if (doctorPolicyString) {
                finalPolicy = `(${doctorPolicyString}) or role:Patient`;
            } else {
                finalPolicy = 'role:Patient';
            }
        } else {
            if (doctorPolicyString) {
                finalPolicy = doctorPolicyString;
            } else {
                alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt vai tr√≤!');
                return;
            }
        }
        
        document.getElementById('policy_expression').value = finalPolicy;
        alert('‚úÖ Ch√≠nh s√°ch ƒë√£ ƒë∆∞·ª£c t·∫°o!');
    });
});

function validateForm() {
    const policyText = document.getElementById('policy_expression').value.trim();
    if (policyText.length === 0) {
        alert('Vui l√≤ng "T·∫°o Ch√≠nh s√°ch" tr∆∞·ªõc khi m√£ h√≥a!');
        return false;
    }
    return true;
}
</script>
{% endblock %}