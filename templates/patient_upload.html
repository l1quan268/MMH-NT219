{% extends "base.html" %}
{% block title %}Táº£i lÃªn Há»“ sÆ¡ CÃ¡ nhÃ¢n{% endblock %}

{% block head %}
<style>
.form-section { margin-bottom: 40px; padding-bottom: 20px; border-bottom: 2px dashed #ccc; }
.form-section:last-child { border-bottom: none; }
.policy-builder { background: #f8f9fa; padding: 25px; border-radius: 12px; margin: 20px 0; border: 1px solid #dee2e6; }
.attribute-group { margin-bottom: 20px; padding: 15px; background: #ffffff; border-radius: 8px; border: 1px solid #e9ecef; }
.attribute-group h4 { color: #2c3e50; margin-bottom: 10px; font-size: 1.1em; }
.attribute-selector { display: flex; flex-wrap: wrap; gap: 10px; }
.attribute-option { display: inline-block; padding: 8px 15px; border: 2px solid #ccc; border-radius: 20px; cursor: pointer; user-select: none; transition: all 0.2s ease-in-out; font-size: 0.9em; }
.attribute-option:hover { border-color: #3498db; background: #eaf5fc; }
.attribute-option.selected { background-color: #3498db; color: white; border-color: #2980b9; font-weight: 600; }
textarea#policy_expression { background-color: #e9ecef; font-family: monospace;}
.status-panel { background: #e8f5e9; padding: 15px; margin: 20px 0; border-radius: 4px; border-left: 5px solid #4CAF50;}
</style>
{% endblock %}

{% block content %}
<h2>ğŸ“ Táº£i lÃªn Há»“ sÆ¡ Sá»©c khá»e CÃ¡ nhÃ¢n</h2>

<!-- ====================================================================== -->
<!-- ==================== BÆ¯á»šC 1: FORM MÃƒ HÃ“A Dá»® LIá»†U ==================== -->
<!-- ====================================================================== -->
<div class="form-section">
    <h3>BÆ°á»›c 1: Chuáº©n bá»‹ vÃ  MÃ£ hÃ³a</h3>
    <p>Chá»n há»“ sÆ¡ cá»§a báº¡n, xÃ¢y dá»±ng chÃ­nh sÃ¡ch truy cáº­p, sau Ä‘Ã³ nháº¥n "MÃ£ hÃ³a" Ä‘á»ƒ táº¡o cÃ¡c file an toÃ n trong thÆ° má»¥c <code>output/</code>.</p>
    
    <form id="encrypt-form" action="{{ url_for('user.patient_upload') }}" method="POST" enctype="multipart/form-data" onsubmit="return validateForm()">
        <div class="form-group">
          <label for="record_description">MÃ´ táº£ há»“ sÆ¡ (vÃ­ dá»¥: Káº¿t quáº£ xÃ©t nghiá»‡m mÃ¡u ngÃ y...)</label>
          <input type="text" id="record_description" name="record_description" required class="form-control" />
        </div>
        <div class="form-group">
          <label for="medical_file">File há»“ sÆ¡</label>
          <input type="file" id="medical_file" name="medical_file" required class="form-control" />
        </div>
        <div class="form-group">
          <label for="public_key_file">Chá»n Public Key cá»§a Há»‡ thá»‘ng</label>
          <input type="file" id="public_key_file" name="public_key_file" accept=".pk" required class="form-control" />
        </div>
        
        <div class="policy-builder">
            <h3>ğŸ”’ XÃ¢y dá»±ng ChÃ­nh sÃ¡ch Truy cáº­p</h3>
            <p>Chá»n nhá»¯ng ngÆ°á»i báº¡n cho phÃ©p xem há»“ sÆ¡ nÃ y.</p>
            <div class="attribute-group">
                <h4>ğŸ‘¥ Vai trÃ² (chá»n Ã­t nháº¥t 1):</h4>
                <div class="attribute-selector">
                    <div class="attribute-option" data-group="role" data-policy="role:Doctor">ğŸ‘¨â€âš•ï¸ BÃ¡c sÄ©</div>
                    <div class="attribute-option" data-group="role" data-policy="role:Nurse">ğŸ‘©â€âš•ï¸ Y tÃ¡</div>
                </div>
            </div>
            <div class="attribute-group">
                <h4>ğŸ¥ ChuyÃªn khoa (tÃ¹y chá»n):</h4>
                <div class="attribute-selector">
                    <div class="attribute-option" data-group="dept" data-policy="dept:Cardiology">â¤ï¸ Khoa Tim máº¡ch</div>
                </div>
            </div>
            <button type="button" class="btn btn-primary" id="generate-policy-btn">âš™ï¸ Táº¡o ChÃ­nh sÃ¡ch</button>
            <button type="button" class="btn btn-danger" id="clear-all-btn">ğŸ—‘ï¸ XÃ³a</button>
        </div>
        <div class="form-group">
          <label for="policy_expression">ChÃ­nh sÃ¡ch Ä‘Æ°á»£c táº¡o (báº¯t buá»™c)</label>
          <textarea id="policy_expression" name="policy_expression" rows="2" readonly required class="form-control"></textarea>
        </div>
        
        <button type="submit" class="btn btn-success" style="width: 100%;">ğŸ”’ MÃ£ hÃ³a vÃ  Táº¡o file Output</button>
    </form>
</div>

<!-- ====================================================================== -->
<!-- ==================== BÆ¯á»šC 2: FORM UPLOAD Dá»® LIá»†U ===================== -->
<!-- ====================================================================== -->
{% if step == 'confirm' %}
<div class="form-section">
    <h3>BÆ°á»›c 2: Táº£i lÃªn Cloud</h3>
    <div class="status-panel">
        <h4>âœ… MÃ£ hÃ³a thÃ nh cÃ´ng!</h4>
        <p>CÃ¡c tá»‡p Ä‘Ã£ Ä‘Æ°á»£c táº¡o trong thÆ° má»¥c <strong>output/</strong>. BÃ¢y giá», hÃ£y chá»n láº¡i chÃºng Ä‘á»ƒ táº£i lÃªn.</p>
    </div>
    <form id="upload-confirm-form" action="{{ url_for('user.patient_do_upload') }}" method="POST" enctype="multipart/form-data">
        <div class="form-group">
            <label>1. Chá»n láº¡i File Báº£n mÃ£ (<code>output/patient_ciphertext.bin</code>)</label>
            <input type="file" name="ciphertext_file_upload" accept=".bin" required class="form-control" />
        </div>
        <div class="form-group">
            <label>2. Chá»n láº¡i File KhÃ³a (<code>output/patient_aes_key_cpabe.ct</code>)</label>
            <input type="file" name="key_file_upload" accept=".ct" required class="form-control" />
        </div>
        <button type="submit" class="btn btn-success" style="width: 100%;">ğŸš€ Táº£i lÃªn Cloud</button>
        <a href="{{ url_for('user.patient_upload') }}" class="btn btn-danger">Há»§y bá»</a>
    </form>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script>
// JavaScript cho Policy Builder (giá»¯ nguyÃªn)
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.attribute-option').forEach(option => {
        option.addEventListener('click', function() { this.classList.toggle('selected'); });
    });

    document.getElementById('clear-all-btn').addEventListener('click', function() {
        document.querySelectorAll('.attribute-option.selected').forEach(el => el.classList.remove('selected'));
        document.getElementById('policy_expression').value = '';
    });

    document.getElementById('generate-policy-btn').addEventListener('click', function() {
        const groups = {};
        const selectedElems = document.querySelectorAll('.attribute-option.selected');
        if (selectedElems.length === 0) {
            alert('Vui lÃ²ng chá»n Ã­t nháº¥t má»™t thuá»™c tÃ­nh!');
            return;
        }
        selectedElems.forEach(el => {
            const group = el.getAttribute('data-group');
            const policy = el.getAttribute('data-policy');
            if (!groups[group]) { groups[group] = []; }
            groups[group].push(policy);
        });
        if (!groups.role || groups.role.length === 0) {
            alert('Báº¯t buá»™c pháº£i chá»n Ã­t nháº¥t má»™t "Vai trÃ²"!');
            return;
        }
        const policyParts = [];
        for (const policies of Object.values(groups)) {
            if (policies.length > 1) {
                policyParts.push(`(${policies.join(' or ')})`);
            } else {
                policyParts.push(policies[0]);
            }
        }
        document.getElementById('policy_expression').value = policyParts.join(' and ');
        alert('âœ… ChÃ­nh sÃ¡ch Ä‘Ã£ Ä‘Æ°á»£c táº¡o!');
    });
});

function validateForm() {
    const policyText = document.getElementById('policy_expression').value.trim();
    if (policyText.length === 0) {
        alert('Vui lÃ²ng "Táº¡o ChÃ­nh sÃ¡ch" trÆ°á»›c khi mÃ£ hÃ³a!');
        return false;
    }
    return true;
}
</script>
{% endblock %}