{% extends "base.html" %}
{% block title %}Xem & Gi·∫£i m√£ H·ªì s∆°{% endblock %}

{% block head %}
<style>
.step-section { margin-bottom: 40px; padding-bottom: 20px; border-bottom: 2px dashed #ccc; }
.step-section:last-child { border-bottom: none; }
.step-section h3 { border-left: 4px solid #3498db; padding-left: 10px; margin-bottom: 15px; }
.record-list li { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
.policy-builder { background: #f0f8ff; padding: 20px; border-radius: 8px; margin-top: 15px; }
.attribute-group { margin-bottom: 15px; }
.attribute-selector { display: flex; flex-wrap: wrap; gap: 10px; }
.attribute-option { display: inline-block; padding: 8px 15px; border: 2px solid #ccc; border-radius: 20px; cursor: pointer; user-select: none; transition: all 0.2s ease-in-out; }
.attribute-option.selected { background-color: #3498db; color: white; border-color: #2980b9; }
</style>
{% endblock %}


{% block content %}
<h2>üë§ Xem v√† Gi·∫£i m√£ H·ªì s∆° B·ªánh √°n</h2>

<!-- ======================================================== -->
<!-- B∆Ø·ªöC 1: XEM V√Ä T·∫¢I V·ªÄ B·∫¢N M√É -->
<!-- ======================================================== -->
<div class="step-section">
    <h3>B∆∞·ªõc 1: T√¨m v√† T·∫£i v·ªÅ H·ªì s∆° M√£ h√≥a</h3>
    
    <!-- ======================================================== -->
    <!-- == N√öT T√åM KI·∫æM CHO B√ÅC Sƒ® ƒê√É ƒê∆Ø·ª¢C TH√äM L·∫†I == -->
    <!-- ======================================================== -->
    {% if session.user.role == 'doctor' %}
        <div class="search-panel" style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
            <h4>T√¨m ki·∫øm H·ªì s∆°</h4>
            <p>H·ªá th·ªëng s·∫Ω t·ª± ƒë·ªông t√¨m c√°c h·ªì s∆° ph√π h·ª£p v·ªõi c√°c thu·ªôc t√≠nh c·ªßa b·∫°n.</p>
            <form method="POST" action="{{ url_for('user.data_user') }}">
                <button class="btn btn-primary" type="submit">üîç T√¨m ki·∫øm theo thu·ªôc t√≠nh</button>
            </form>
        </div>
    {% endif %}
    
    {% if results %}
        <p><strong>Danh s√°ch h·ªì s∆°:</strong></p>
        <ul class="record-list" style="list-style: none; padding: 0; margin-top: 10px;">
            {% for r in results %}
                <li>
                    <div>
                        <p><strong>B·ªánh nh√¢n:</strong> {{ r.patient_name }} (M√¥ t·∫£: {{ r.record_description }})</p>
                        <p><strong>Ch√≠nh s√°ch:</strong> <code>{{ r.access_policy }}</code></p>
                    </div>
                    <form action="{{ url_for('user.download_record') }}" method="POST" style="display:inline;">
                        <input type="hidden" name="doc_id" value="{{ r._id }}">
                        <button type="submit" class="btn">üì• T·∫£i v·ªÅ B·∫£n m√£</button>
                    </form>
                </li>
            {% else %}
                 <li>Kh√¥ng t√¨m th·∫•y h·ªì s∆° n√†o.</li>
            {% endfor %}
        </ul>
    {% else %}
        {% if request.method == 'POST' %}
            <p>Kh√¥ng t√¨m th·∫•y h·ªì s∆° n√†o ph√π h·ª£p v·ªõi thu·ªôc t√≠nh c·ªßa b·∫°n.</p>
        {% elif session.user.role == 'patient' %}
             <p>B·∫°n ch∆∞a c√≥ h·ªì s∆° n√†o.</p>
        {% endif %}
    {% endif %}
</div>


<!-- ======================================================== -->
<!-- B∆Ø·ªöC 2: Y√äU C·∫¶U C·∫§P KH√ìA B√ç M·∫¨T (SECRET KEY) -->
<!-- ======================================================== -->
<div class="step-section">
    <h3>B∆∞·ªõc 2: Y√™u c·∫ßu Kh√≥a Gi·∫£i m√£ (Secret Key)</h3>
    
    {% if session.user.role == 'doctor' %}
        <p>H·ªá th·ªëng ƒë√£ ghi nh·∫≠n c√°c thu·ªôc t√≠nh c·ªßa b·∫°n. Nh·∫•n n√∫t d∆∞·ªõi ƒë√¢y ƒë·ªÉ y√™u c·∫ßu c·∫•p m·ªôt Kh√≥a B√≠ m·∫≠t t∆∞∆°ng ·ª©ng.</p>
        <div class="policy-builder">
            <h4>C√°c thu·ªôc t√≠nh hi·ªán t·∫°i c·ªßa b·∫°n:</h4>
            {% if session.user.attributes %}
                <ul>
                {% for attr in session.user.attributes %}
                    <li><code>{{ attr }}</code></li>
                {% endfor %}
                </ul>
            {% else %}
                <p>Kh√¥ng c√≥ thu·ªôc t√≠nh n√†o ƒë∆∞·ª£c ghi nh·∫≠n.</p>
            {% endif %}

            <!-- Form n√†y s·∫Ω g·ª≠i y√™u c·∫ßu m√† kh√¥ng c·∫ßn ng∆∞·ªùi d√πng ch·ªçn g√¨ th√™m -->
            <form action="{{ url_for('user.request_secret_key') }}" method="POST">
                <button type="submit" class="btn btn-success">üîë Y√™u c·∫ßu c·∫•p kh√≥a</button>
            </form>
        </div>
    {% else %}
         <!-- B·ªánh nh√¢n c√≥ th·ªÉ c√≥ quy tr√¨nh y√™u c·∫ßu kh√≥a kh√°c ho·∫∑c ƒë∆°n gi·∫£n h∆°n -->
         <p>V·ªõi vai tr√≤ b·ªánh nh√¢n, b·∫°n c√≥ th·ªÉ y√™u c·∫ßu kh√≥a gi·∫£i m√£ cho c√°c h·ªì s∆° c·ªßa m√¨nh.</p>
         <form action="{{ url_for('user.request_secret_key') }}" method="POST">
            <!-- G·ª≠i ƒëi thu·ªôc t√≠nh m·∫∑c ƒë·ªãnh c·ªßa b·ªánh nh√¢n -->
            <input type="hidden" name="attributes" value="role:Patient">
            <button type="submit" class="btn btn-success">üîë Y√™u c·∫ßu c·∫•p kh√≥a</button>
        </form>
    {% endif %}
</div>


<!-- ======================================================== -->
<!-- B∆Ø·ªöC 3: GI·∫¢I M√É T·∫†I LOCAL -->
<!-- ======================================================== -->
<div class="step-section">
    <h3>B∆∞·ªõc 3: Gi·∫£i m√£ H·ªì s∆°</h3>
    <p>Ch·ªçn c√°c file b·∫°n ƒë√£ t·∫£i v·ªÅ ·ªü c√°c b∆∞·ªõc tr√™n ƒë·ªÉ ti·∫øn h√†nh gi·∫£i m√£.</p>
    <form action="{{ url_for('user.decrypt_record') }}" method="POST" enctype="multipart/form-data">
        <div class="form-group">
            <label>1. File B·∫£n m√£ H·ªì s∆° (<code>ciphertext.bin</code>)</label>
            <input type="file" name="ciphertext_file" required class="form-control">
        </div>
        <div class="form-group">
            <label>2. File Kh√≥a AES ƒë√£ m√£ h√≥a (<code>aes_key_cpabe.ct</code>)</label>
            <input type="file" name="encrypted_key_file" required class="form-control">
        </div>
        <div class="form-group">
            <label>3. File Kh√≥a B√≠ m·∫≠t c·ªßa b·∫°n (<code>secret_key.sk</code>)</label>
            <input type="file" name="secret_key_file" required class="form-control">
        </div>
        <div class="form-group">
            <label>4. File Public Key c·ªßa h·ªá th·ªëng (<code>public_key.pk</code>)</label>
            <input type="file" name="public_key_file" required class="form-control">
        </div>
        <button type="submit" class="btn btn-success" style="width: 100%;">üîì Gi·∫£i m√£</button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.attribute-option').forEach(option => {
        option.addEventListener('click', function() { this.classList.toggle('selected'); });
    });

    document.getElementById('request-key-btn').addEventListener('click', function() {
        const selectedAttrs = document.querySelectorAll('.attribute-option.selected');
        if (selectedAttrs.length === 0) {
            alert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt thu·ªôc t√≠nh c·ªßa b·∫°n!');
            return;
        }
        const form = document.createElement('form');
        form.method = 'POST';
        form.action = "{{ url_for('user.request_secret_key') }}";
        
        selectedAttrs.forEach(el => {
            const input = document.createElement('input');
            input.type = 'hidden';
            input.name = 'attributes';
            input.value = el.getAttribute('data-attr');
            form.appendChild(input);
        });
        document.body.appendChild(form);
        form.submit();
        document.body.removeChild(form);
    });
});
</script>
{% endblock %}